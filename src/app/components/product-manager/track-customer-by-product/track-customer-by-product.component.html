<div class="fields p-top-right">
  <p-dropdown [options]="listBranchs" [(ngModel)]="query.branchId" [autoDisplayFirst]="false" optionLabel="branchName" optionValue="branchId" (onChange)="changeBranch()" [appendTo]="'body'" [filter]="true" filterBy="branchName"></p-dropdown>
</div>
<p-toast position="top-center" key="toast1"  [baseZIndex]="999999999999"></p-toast>
<div class="main-grid">
    <section class="bread-crumb" >
        <div class="flex bet middle">
            <div class="md:col-8 sm:col-12 p-0">
                <app-hrm-breadcrumb [items]="itemsBreadcrumb" ></app-hrm-breadcrumb>
            </div>
            <div class="md:col-4 sm:col-0 p-0 flex justify-content-end align-items-center dropdown-branch">
                <p-button label="Tìm kiếm" icon="pi pi-sliders-h" (click)="displayFilter = !displayFilter" styleClass="p-button-outlined p-button-rounded p-button-secondary"
                [style]="{'margin-right': '20px'}"></p-button>
            </div>
        </div>
    </section>
    <!-- this.organizeInfoService.setStocks(e.value); -->
    <p-divider type="solid"></p-divider>

    <div class="card ">
       <div class="table-default" #container>
        <app-list-grid-angular  *ngIf="!isLoading" [idGrid]="'my-table'" [isShowTotalBottom]="true"
        [groupDefaultExpanded]="1"
          [columnsWithAggregation]="['quantity', 'profit', 'amount', 'customerName']"
            [listsData]="listDatas" [height]="heightGrid" [autoGroupColumnDef]="autoGroupColumnDef"
             [groupDisplayType]="groupDisplayType" (rowGroupOpenedCallback)="rowGroupOpenedCallback($event)"
            [columnDefs]="columnDefs" [getContextMenuItems]="getContextMenuItems" [getRowId]="getRowId"
            [detailCellRendererParams]="detailCellRendererParams"></app-list-grid-angular>
            <app-loading-grid *ngIf="isLoading" [cols]="cols" [lists]="20"></app-loading-grid>
        <!-- <p-table [value]="isLoading ? listDatasLoading : listDatas"  *ngIf="screenWidth<= 960" [columns]="cols"
         [resizableColumns]="true" [scrollable]="screenWidth> 960" scrollHeight="{{heightGrid}}px"
          responsiveLayout="stack" [breakpoint]="'960px'"  styleClass="table-row  p-datatable-sm">
            <ng-template pTemplate="header" let-columns>
                <tr>
                    <th *ngFor="let col of columns">
                        {{ col.header }}
                      </th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-product let-columns="columns">
                <tr [pSelectableRow]="product">
                    <ng-container *ngFor="let col of columns">
                        <td *ngIf="col.typeField === 'text'">
                            <span class="p-column-title">{{ col.header }}</span><p-skeleton *ngIf="isLoading"></p-skeleton> {{ product[col.field] }}
                        </td>
                        <td *ngIf="col.typeField === 'number'">
                            <span class="p-column-title">{{ col.header }}</span><p-skeleton *ngIf="isLoading"></p-skeleton> {{ product[col.field] | number}}
                        </td>
                    </ng-container>
                </tr>
            </ng-template>
        </p-table>
        <p-table [value]="isLoading ? listDatasLoading : listDatas"  *ngIf="screenWidth> 960 && isLoading" [columns]="cols"
        [resizableColumns]="true" [scrollable]="screenWidth> 960" scrollHeight="{{heightGrid}}px"
         responsiveLayout="stack" [breakpoint]="'960px'"  styleClass="table-row  p-datatable-sm">
           <ng-template pTemplate="header" let-columns>
               <tr>
                <th *ngFor="let col of columns">
                    {{ col.header }}
                  </th>
               </tr>
           </ng-template>
           <ng-template pTemplate="body" let-product let-columns="columns">
               <tr [pSelectableRow]="product">
                <ng-container *ngFor="let col of columns">
                    <td *ngIf="col.typeField === 'text'">
                        <span class="p-column-title">{{ col.header }}</span><p-skeleton *ngIf="isLoading"></p-skeleton> {{ product[col.field] }}
                    </td>
                    <td *ngIf="col.typeField === 'number'">
                        <span class="p-column-title">{{ col.header }}</span><p-skeleton *ngIf="isLoading"></p-skeleton> {{ product[col.field] | number}}
                    </td>
                </ng-container>
               </tr>
           </ng-template>
       </p-table>
        <p-table  *ngIf="screenWidth> 960 && !isLoading" rowGroupMode="subheader" sortField="customer.customerName" id="my-table" [columns]="cols"
        [scrollable]="screenWidth> 960" scrollHeight="{{heightGrid}}px"
          responsiveLayout="stack" [expandedRowKeys]="expandedRows"
         groupRowsBy="customer.customerName" dataKey="customer.customerName"
          sortMode="single" [value]="isLoading ? listDatasLoading : listDatas"
            [resizableColumns]="true"  [breakpoint]="'960px'"
             styleClass="table-row  p-datatable-sm">
            <ng-template pTemplate="header" let-columns>
                <tr>
                    <th *ngFor="let col of columns">
                        {{ col.header }}
                      </th>
                </tr>
            </ng-template>
            <ng-template *ngIf="!isLoading" pTemplate="groupheader" let-product let-rowIndex="rowIndex" let-expanded="expanded">
                <tr>
                    <td colspan="4">
                        <button type="button" pButton pRipple [pRowToggler]="product" class="p-button-text td-button-dropdown p-button-rounded p-button-plain mr-2" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                        <span class="font-bold ml-2">{{product?.customer?.customerName}}</span>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="groupfooter" let-product>
                <tr class="p-rowgroup-footer">
                    <td colspan="4" style="text-align: left;font-weight: bold; ">Tổng tiền: {{calculateCustomerTotal(product.customer.customerName) | number}}</td>
                </tr>
            </ng-template>
            <ng-template pTemplate="rowexpansion" let-product let-columns="columns">
                <tr [pSelectableRow]="product">
                    <ng-container *ngFor="let col of columns">
                        <td *ngIf="col.typeField === 'text'">
                            {{ product[col.field] }}
                        </td>
                        <td *ngIf="col.typeField === 'number'">
                            {{ product[col.field] | number}}
                        </td>
                    </ng-container>
                </tr>

            </ng-template>
        </p-table> -->
        <!-- <div class="paginator flex justify-content-end align-items-center" style="background-color: #fff;background-color: #fff;
        position: fixed;
        bottom: 0;
        width: 100%;
        left: 0;">
            <span>Từ {{ countRecord.currentRecordStart }} đến {{ countRecord.currentRecordEnd }} trên tổng số {{ countRecord.totalRecord }} kết quả</span>
            <p-paginator [rows]="query.size" [totalRecords]="countRecord.totalRecord" [first]="first"
                (onPageChange)="paginate($event)" [rowsPerPageOptions]="[20,40,60,100,200,{ showAll: 'ALL' }]">
            </p-paginator>
        </div> -->
        </div>
        </div>
</div>
<p-sidebar [(visible)]="displayFilter" (onHide)="displayFilter = false" position="right" styleclass="w-30rem">
    <ng-template pTemplate="header">
        <div class="flex grid justify-content-end">
            <button type="button" pButton pRipple icon="pi pi-search" label="Tìm kiếm" (click)="find()" class="p-button-secondary mr-1 p-button-sm"></button>
            <!-- <button type="button" pButton pRipple icon="pi pi-times" label="Làm mới" (click)="refresh(); displayFilter=false" class="p-button-danger p-button-sm"></button>   -->
        </div>
    </ng-template>
    <div class="p-fluid grid formgrid">
        <div class="field col-12 md:col-12">
            <label for="icon">Chi nhánh</label>
            <p-dropdown [options]="listBranchs" [(ngModel)]="query.branchId" [autoDisplayFirst]="false" optionLabel="branchName" optionValue="branchId" (onChange)="changeBranch()" [appendTo]="'body'" [filter]="true" filterBy="branchName"></p-dropdown>
        </div>
        <!-- <div class="field col-12 md:col-12">
            <label for="icon">Nhóm sản phẩm</label>
            <p-autoComplete
            field="categoryName"
            placeholder="Tìm kiếm nhóm sản phẩm"
            [dropdownAriaLabel]="'sadasd'"
            [(ngModel)]="infoCategory"
            id="FullName"
            [suggestions]="productCategorys"
            [lazy]="true"
            [showEmptyMessage]="true"
            [emptyMessage]="'Không tìm thấy dữ liệu search'"
            [showClear]="true"
            [appendTo]="'body'"
            [style]="{'width':'100%'}"
            [inputStyle]="{'width':'100%'}"
            (onSelect)="changeProductCategory()"
            (onClear)="onClearProductCategory()"
            (completeMethod)="getListProductCategory($event.query)"
            ></p-autoComplete>
        </div> -->
        <div class="field col-12 md:col-12">
            <label for="icon">Sản phẩm</label>
            <p-autoComplete
            field="productName"
            placeholder="Tìm kiếm sản phẩm"
            [dropdownAriaLabel]="'sadasd'"
            [(ngModel)]="infoProduct"
            id="FullName"
            [suggestions]="products"
            [lazy]="true"
            [showEmptyMessage]="true"
            [emptyMessage]="'Không tìm thấy dữ liệu search'"
            [showClear]="true"
            [appendTo]="'body'"
            [style]="{'width':'100%'}"
            [inputStyle]="{'width':'100%'}"
            (onSelect)="changeProduct()"
            (onClear)="onClear()"
            (completeMethod)="getListproduct($event.query)"
            ></p-autoComplete>



            <!-- <p-dropdown [options]="customers" [(ngModel)]="query.customerId" [autoDisplayFirst]="false" optionLabel="customerName" optionValue="customerId" (onChange)="changeSupplier()" [appendTo]="'body'" [filter]="true" filterBy="customerName"></p-dropdown> -->
        </div>
        <div class="field col-12 md:col-12">
            <label for="dateformat">Từ ngày</label>
            <p-calendar placeholder="Từ ngày"
                panelStyleClass="datepicker-default-only-icon" placeholder="Từ ngày (YYYY-MM-DD)"
                [baseZIndex]="101" [(ngModel)]="query.startDate"  [appendTo]="'body'"
                [monthNavigator]="true"
                [yearNavigator]="true" inputId="navigators" dateFormat="yy-mm-dd"
                name="startDate"></p-calendar>
        </div>

        <div class="field col-12 md:col-12">
            <label for="icon">Đến ngày</label>
            <p-calendar placeholder="Từ ngày"
            panelStyleClass="datepicker-default-only-icon" placeholder="Từ ngày (YYYY-MM-DD)"
            [appendTo]="'body'" [baseZIndex]="101" [(ngModel)]="query.endDate"
            [monthNavigator]="true"
            [yearNavigator]="true" inputId="navigators" dateFormat="yy-mm-dd"
            name="endDate"></p-calendar>
        </div>
    </div>
</p-sidebar>
